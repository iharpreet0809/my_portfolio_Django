# Deployment for Celery Worker
# Processes asynchronous background tasks (emails, data processing, etc.)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: celery-worker
  namespace: portfolio
spec:
  replicas: 1  # Number of worker pods (scale based on task load)
  selector:
    matchLabels:
      app: celery-worker
  template:
    metadata:
      labels:
        app: celery-worker
    spec:
      # Init containers ensure dependencies are ready before worker starts
      initContainers:
      - name: wait-for-mysql
        image: busybox:1.35
        command:
          - sh
          - -c
          - |
            # Wait for MySQL to be accessible (worker needs DB for task results)
            until nc -z mysql 3306; do
              echo "Waiting for MySQL..."
              sleep 2
            done
            echo "MySQL is ready!"
      - name: wait-for-redis
        image: busybox:1.35
        command:
          - sh
          - -c
          - |
            # Wait for Redis to be accessible (worker gets tasks from Redis queue)
            until nc -z redis 6379; do
              echo "Waiting for Redis..."
              sleep 2
            done
            echo "Redis is ready!"
      # Main Celery worker container
      containers:
      - name: celery-worker
        image: harpreetdevops/portfolio:latest  # Same image as Django
        imagePullPolicy: Always
        # Override default CMD to run Celery worker instead of Gunicorn
        command:
          - celery  # Celery command-line tool
          - -A  # Application flag
          - portfolio_django  # Django project name
          - worker  # Run as worker (processes tasks)
          - --loglevel=info  # Logging verbosity
          - --concurrency=2  # Number of worker processes (adjust based on CPU)
          - --queues=celery,default,emails  # Queues this worker listens to
        env:
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: SECRET_KEY
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: portfolio-config
              key: DEBUG
        - name: DJANGO_SETTINGS_MODULE
          valueFrom:
            configMapKeyRef:
              name: portfolio-config
              key: DJANGO_SETTINGS_MODULE
        - name: MYSQL_HOST
          value: "mysql"
        - name: MYSQL_PORT
          valueFrom:
            configMapKeyRef:
              name: portfolio-config
              key: MYSQL_PORT
        - name: MYSQL_DB
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: MYSQL_DB
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: MYSQL_USER
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: MYSQL_PASSWORD
        - name: REDIS_URL  # Redis connection for task queue
          value: "redis://redis:6379/0"
        # Resource limits for Celery worker
        resources:
          requests:
            memory: "256Mi"  # Minimum memory
            cpu: "200m"
          limits:
            memory: "512Mi"  # Maximum memory
            cpu: "400m"
        # Mount logs volume
        volumeMounts:
        - name: logs
          mountPath: /app/logs  # Celery writes logs here
        # Liveness probe - checks if Celery worker is responsive
        # Uses Celery's inspect command to ping workers
        livenessProbe:
          exec:
            command:
            - celery  # Celery CLI
            - -A  # Application
            - portfolio_django
            - inspect  # Inspect command
            - ping  # Ping all workers
          initialDelaySeconds: 60  # Wait for worker to start
          periodSeconds: 30  # Check every 30 seconds
          timeoutSeconds: 10
          failureThreshold: 3  # Restart after 3 failures
      # Define volumes
      volumes:
      - name: logs
        persistentVolumeClaim:
          claimName: logs-pvc  # Shared logs volume
