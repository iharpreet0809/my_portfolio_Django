# ConfigMap containing Nginx configuration
# Stores nginx.conf as data that can be mounted into pods
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: portfolio
data:
  default.conf: |
    # Upstream definition - load balances across Django pods
    upstream django {
        server django:8000;  # Points to Django service (Kubernetes DNS)
    }

    # HTTP server block - handles port 80 traffic
    server {
        listen 80;  # Listen on HTTP port
        server_name iharpreet.com www.iharpreet.com;  # Your domain names

        # Allow Certbot to verify domain ownership for SSL certificates
        # Certbot places challenge files in this directory
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;  # Certbot webroot
        }

        # Redirect all other HTTP traffic to HTTPS
        location / {
            return 301 https://$host$request_uri;  # 301 permanent redirect
        }
    }

    # HTTPS server block - handles port 443 traffic
    server {
        listen 443 ssl http2;  # Listen on HTTPS with HTTP/2 support
        server_name iharpreet.com www.iharpreet.com;

        # SSL certificate paths (generated by Certbot)
        ssl_certificate /etc/letsencrypt/live/iharpreet.com/fullchain.pem;  # Public certificate
        ssl_certificate_key /etc/letsencrypt/live/iharpreet.com/privkey.pem;  # Private key
        
        # SSL security settings
        ssl_protocols TLSv1.2 TLSv1.3;  # Only allow secure TLS versions
        ssl_ciphers HIGH:!aNULL:!MD5;  # Strong cipher suites only
        ssl_prefer_server_ciphers on;  # Server chooses cipher

        client_max_body_size 20M;  # Allow uploads up to 20MB

        # Serve static files directly from Nginx (faster than Django)
        location /static/ {
            alias /app/staticfiles/;  # Path to static files
            expires 30d;  # Cache for 30 days
            add_header Cache-Control "public, immutable";  # Browser caching
        }

        # Serve media files (user uploads)
        location /media/ {
            alias /app/media/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # Proxy all other requests to Django
        location / {
            proxy_pass http://django;  # Forward to Django upstream
            proxy_set_header Host $host;  # Preserve original host header
            proxy_set_header X-Real-IP $remote_addr;  # Client's real IP
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Proxy chain
            proxy_set_header X-Forwarded-Proto $scheme;  # Original protocol (https)
            proxy_redirect off;  # Don't rewrite redirects
        }
    }
---
# Service for Nginx
# Exposes Nginx to the internet via LoadBalancer
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: portfolio
  labels:
    app: nginx
spec:
  type: LoadBalancer  # Creates external load balancer (gets public IP)
  ports:
    - port: 80  # HTTP port
      targetPort: 80
      name: http
    - port: 443  # HTTPS port
      targetPort: 443
      name: https
  selector:
    app: nginx  # Routes traffic to Nginx pods
---
# Deployment for Nginx web server
# Acts as reverse proxy and serves static files
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: portfolio
spec:
  replicas: 2  # Run 2 Nginx pods for high availability
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest  # Official Nginx image
        ports:
        - containerPort: 80  # HTTP port
          name: http
        - containerPort: 443  # HTTPS port
          name: https
        # Resource limits - Nginx is lightweight
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        # Mount configuration and data volumes
        volumeMounts:
        - name: nginx-config  # Custom Nginx configuration
          mountPath: /etc/nginx/conf.d  # Nginx config directory
        - name: staticfiles  # Django static files
          mountPath: /app/staticfiles
          readOnly: true  # Nginx only reads, doesn't write
        - name: certbot-www  # Certbot webroot for domain verification
          mountPath: /var/www/certbot
          readOnly: true
        - name: certbot-conf  # SSL certificates from Certbot
          mountPath: /etc/letsencrypt
          readOnly: true
        # Liveness probe - checks if Nginx is responding
        livenessProbe:
          httpGet:
            path: /  # Check root path
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        # Readiness probe - checks if Nginx is ready to serve
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      # Define volumes used by containers
      volumes:
      - name: nginx-config  # Nginx configuration from ConfigMap
        configMap:
          name: nginx-config
      - name: staticfiles  # Shared static files from Django
        persistentVolumeClaim:
          claimName: staticfiles-pvc
      - name: certbot-www  # Certbot webroot for challenges
        persistentVolumeClaim:
          claimName: certbot-www-pvc
      - name: certbot-conf  # SSL certificates
        persistentVolumeClaim:
          claimName: certbot-conf-pvc
---
# PersistentVolumeClaim for Certbot webroot
# Stores ACME challenge files for domain verification
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: certbot-www-pvc
  namespace: portfolio
spec:
  accessModes:
    - ReadWriteMany  # Multiple pods (Nginx, Certbot) need access
  resources:
    requests:
      storage: 1Gi  # Small storage for challenge files
---
# PersistentVolumeClaim for SSL certificates
# Stores Let's Encrypt certificates and keys
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: certbot-conf-pvc
  namespace: portfolio
spec:
  accessModes:
    - ReadWriteMany  # Multiple Nginx pods need to read certificates
  resources:
    requests:
      storage: 1Gi  # Small storage for certificates
