# Deployment for Celery Beat
# Scheduler that triggers periodic tasks (like cron jobs)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: celery-beat
  namespace: portfolio
spec:
  replicas: 1  # MUST be 1 - multiple beat schedulers will cause duplicate tasks
  selector:
    matchLabels:
      app: celery-beat
  template:
    metadata:
      labels:
        app: celery-beat
    spec:
      # Init containers ensure dependencies are ready
      initContainers:
      - name: wait-for-mysql
        image: busybox:1.35
        command:
          - sh
          - -c
          - |
            # Wait for MySQL (beat stores schedule in database)
            until nc -z mysql 3306; do
              echo "Waiting for MySQL..."
              sleep 2
            done
            echo "MySQL is ready!"
      - name: wait-for-redis
        image: busybox:1.35
        command:
          - sh
          - -c
          - |
            # Wait for Redis (beat sends tasks to Redis queue)
            until nc -z redis 6379; do
              echo "Waiting for Redis..."
              sleep 2
            done
            echo "Redis is ready!"
      # Main Celery Beat container
      containers:
      - name: celery-beat
        image: harpreetdevops/portfolio:latest  # Same image as Django
        imagePullPolicy: Always
        # Override default CMD to run Celery Beat scheduler
        command:
          - celery  # Celery command
          - -A  # Application flag
          - portfolio_django  # Django project name
          - beat  # Run as beat scheduler (not worker)
          - --loglevel=info  # Logging verbosity
          - --scheduler  # Scheduler backend
          - django_celery_beat.schedulers:DatabaseScheduler  # Store schedule in Django database
        env:
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: SECRET_KEY
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: portfolio-config
              key: DEBUG
        - name: DJANGO_SETTINGS_MODULE
          valueFrom:
            configMapKeyRef:
              name: portfolio-config
              key: DJANGO_SETTINGS_MODULE
        - name: MYSQL_HOST
          value: "mysql"
        - name: MYSQL_PORT
          valueFrom:
            configMapKeyRef:
              name: portfolio-config
              key: MYSQL_PORT
        - name: MYSQL_DB
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: MYSQL_DB
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: MYSQL_USER
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: portfolio-secrets
              key: MYSQL_PASSWORD
        - name: REDIS_URL  # Redis connection for sending scheduled tasks
          value: "redis://redis:6379/0"
        # Resource limits - Beat is lightweight (just scheduling, not processing)
        resources:
          requests:
            memory: "128Mi"  # Minimum memory
            cpu: "100m"
          limits:
            memory: "256Mi"  # Maximum memory
            cpu: "200m"
        # Mount logs volume
        volumeMounts:
        - name: logs
          mountPath: /app/logs  # Beat writes schedule logs here
      # Define volumes
      volumes:
      - name: logs
        persistentVolumeClaim:
          claimName: logs-pvc  # Shared logs volume
